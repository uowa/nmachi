#!/usr/bin/env node

/**
 * ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿
 */
const app = require('../app');                     // Expressã‚¢ãƒ—ãƒªæœ¬ä½“
const debug = require('debug')('pmachi6:server'); // ãƒ‡ãƒãƒƒã‚°ç”¨
const fs = require('fs');                          // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç”¨
const http = require('http');                      // HTTPã‚µãƒ¼ãƒãƒ¼ç”¨
const https = require('https');                    // HTTPSã‚µãƒ¼ãƒãƒ¼ç”¨

/**
 * ãƒãƒ¼ãƒˆç•ªå·ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
 * - æ•°å­—ãªã‚‰ãã®ã¾ã¾è¿”ã™
 * - named pipe ãªã‚‰æ–‡å­—åˆ—ã‚’è¿”ã™
 * - ç„¡åŠ¹ãªã‚‰ false ã‚’è¿”ã™
 */
function normalizePort(val) {
  const port = parseInt(val, 10);

  if (isNaN(port)) {
    // æ•°å­—ã«å¤‰æ›ã§ããªã‘ã‚Œã° named pipe ã¨ã¿ãªã™
    return val;
  }

  if (port >= 0) {
    // æ­£ã®æ•°å­—ãªã‚‰ãƒãƒ¼ãƒˆç•ªå·ã¨ã—ã¦è¿”ã™
    return port;
  }

  return false; // ç„¡åŠ¹ãªãƒãƒ¼ãƒˆ
}

/**
 * ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
 */
function onError(error) {
  if (error.syscall !== 'listen') {
    throw error; // listen ç³»ã®ã‚¨ãƒ©ãƒ¼ã§ãªã‘ã‚Œã°æŠ•ã’ã‚‹
  }

  const bind = typeof port === 'string'
    ? 'Pipe ' + port  // named pipe ã®å ´åˆ
    : 'Port ' + port; // ãƒãƒ¼ãƒˆç•ªå·ã®å ´åˆ

  // ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã«å¯¾ã—ã¦ã‚ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' ã¯æ—¢ã«ä½¿ç”¨ä¸­ã§ã™');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã¨ãã®å‡¦ç†
 */
function onListening() {
  const addr = server.address();
  const bind = typeof addr === 'string'
    ? 'pipe ' + addr      // named pipe ã®å ´åˆ
    : 'port ' + addr.port; // ãƒãƒ¼ãƒˆç•ªå·ã®å ´åˆ
  debug('Listening on ' + bind); // ãƒ‡ãƒãƒƒã‚°ç”¨å‡ºåŠ›
}

/**
 * ç’°å¢ƒå¤‰æ•°ã‚„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‹ã‚‰ãƒãƒ¼ãƒˆç•ªå·ã‚’å–å¾—ã—ã¦ Express ã«è¨­å®š
 */
const port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

/**
 * ã‚µãƒ¼ãƒãƒ¼ä½œæˆ
 * - SSL ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã° HTTPS
 * - ãªã‘ã‚Œã° HTTP
 */
let server;

try {
  // SSL è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  const nmachi_key = '../../../../usr/local/nginx/nmachi20201226.key';
  const nmachi_crt = '../../../../usr/local/nginx/nmachi20220126.crt';
  const nmachi_chain = '../../../../usr/local/nginx/nmachi20220126.pem';

  // SSL ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆ
  const options = {
    key: fs.readFileSync(nmachi_key),
    cert: fs.readFileSync(nmachi_crt),
    ca: fs.readFileSync(nmachi_chain)
  };

  // HTTPS ã‚µãƒ¼ãƒãƒ¼ä½œæˆ
  server = https.createServer(options, app);
  console.log('HTTPS ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ');
} catch (err) {
  // ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° HTTP ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  console.warn('SSL ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTTP ã‚µãƒ¼ãƒãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
  server = http.createServer(app);
}

/**
 * Socket.IO ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 * - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
 */
const io = require('socket.io')(server);

/**
 * ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
 */
server.listen(port);
server.on('error', onError);
server.on('listening', onListening);







let user = {};
let uowaFlag = {};
let ip = {};

let roomString = ["ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹", "ã†ã¡ã‚…ãƒ¼", "æ˜Ÿ1",];
let streamer = {}
let redoStock = {};
let clearStock = {};
let oekaki = {};
for (let i = 0; i < roomString.length; i++) {
  oekaki[roomString[i]] = {};
  redoStock[roomString[i]] = {};
  clearStock[roomString[i]] = {};
  streamer[roomString[i]] = [];
}

let userOekaki = {};
let userRedoStock = {};
let userClearStock = {};

let tokenNum = 0;
let tokenID = [];

let users = { "ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹": 0, "ã†ã¡ã‚…ãƒ¼": 0, "æ˜Ÿ1": 0, };

const crypto = require("crypto");
const { setInterval } = require('timers');
// const cipers = crypto.getCiphers();
// console.log(cipers);
// const hashes = crypto.getHashes();
// console.log(hashes);

function tripCreate(isTrip) {
  let tripkey = isTrip;
  let salt = tripkey + "H.";//æœªå…¥åŠ›ã€åˆã¯1æ–‡å­—å…¥ã‚Œç”¨ã«H.ã‚’è¿½åŠ ï¼Ÿï¼Ÿ
  salt = salt.substr(1, 2);//2æ–‡å­—ç›®ã¨3æ–‡å­—ç›®ã‚’åˆ‡ã‚Šå‡ºã™
  salt = salt.replace(/[^.-z]/g, ".");
  salt = salt.replace(/:/g, "A");
  salt = salt.replace(/;/g, "B");
  salt = salt.replace(/</g, "C");
  salt = salt.replace(/=/g, "D");
  salt = salt.replace(/>/g, "E");
  salt = salt.replace(/\?/g, "F");
  salt = salt.replace(/@/g, "G");
  salt = salt.replace(/\[/g, "a");
  salt = salt.replace(/\\/g, "b");
  salt = salt.replace(/]/g, "c");
  salt = salt.replace(/\^/g, "d");
  salt = salt.replace(/_/g, "e");
  salt = salt.replace(/`/g, "f");
  let cipher = crypto.createCipher("des", salt);
  cipher.update(tripkey, 'utf-8', 'base64');
  let cipheredText = cipher.final('base64');
  let trip = cipheredText.substr(-10);
  trip = trip.replace(/=/g, "");//ãªã‚“ã‹ã‚ˆãã‚ã‹ã‚‰ã‚“ã‘ã©ã€é«˜ç¢ºç‡ã§å¾Œã‚ã«==ãŒä»˜ãã®ã§æ¶ˆã™
  trip = "â—†" + trip;
  return trip;
}


let msgSE = {};
msgSE.login = {};
msgSE.login.in = new Array(0);
msgSE.login.logout = new Array(0);
msgSE.other = {};
msgSE.other.in = new Array(1);
msgSE.other.out = new Array(3);
msgSE.other.logout = new Array(1);
msgSE.utyu = {};
msgSE.utyu.in = new Array(1);
msgSE.utyu.out = new Array(1);
msgSE.utyu.logout = new Array(1);

function time() {
  return " -- " + new Date().getHours().toLocaleString() + ":" + new Date().getMinutes().toLocaleString() + "--";
}




function volumeRandom(room, move) {
  let random;
  if (room == "ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹") {//â€»éƒ¨å±‹æ•°ãŒå¢—ãˆãŸã‚‰||ã§ç¶™ãè¶³ã™
    random = Math.floor(Math.random() * msgSE.other[move].length);
  } else if (room === "ã†ã¡ã‚…ãƒ¼" || room === "æ˜Ÿ1") {
    random = Math.floor(Math.random() * msgSE.utyu[move].length);
  } else {//éƒ¨å±‹ã”ã¨ã«SEã‚’å‰²ã‚ŠæŒ¯ã£ã¦ã‚‹å ´åˆ
    random = Math.floor(Math.random() * msgSE[room][move].length);
  }
  return random;
}


io.on('connection', function (socket) {
  //ãƒ•ã‚©ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ 

  function saikiMsg() {
    io.to(socket.id).json.emit("emitSaikiMsg", {
      msg: "ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦ãã ã•ã„",
    });
  }
  //æ™‚é–“ã§çœ ã£ã¦ã‚‹æ™‚ã«çœ ã‚‰ã›ã‚‹ï¼Ÿâ†è¡¨ç¤ºã‚’èµ·ãã‚‹ã«åˆ‡ã‚Šæ›¿ãˆè§£ã„ãŸã‚‰ã„ã„
  //è‡ªåˆ†ã§çœ ã‚‰ã›ãŸæ™‚ã«æ™‚é–“ã§çœ ã‚‹â†ã“ã®ã¾ã¾

  //è‡ªåˆ†ã§çœ ã£ã¦ã‚‹æ™‚ã¯ãã®ã¾ã¾
  //æ™‚é–“ã§çœ ã£ã¦ã‚‹æ™‚ã¯å‹•ã‹ã—ãŸã‚‰å‹•ã

  socket.on("getMyUser", function () {
    tokenID[socket.id] = "tokenID" + tokenNum;
    user[tokenID[socket.id]] = {
      userName: "åã‚‚ãªãåç„¡ã—",
      token: tokenID[socket.id],
      AX: 457,
      AY: 80,
      DIR: "S",
      msg: "",
      avatar: "gomaneco",
      room: "loginBack",
      video: false,
      audio: false,
      timeShade: new Date().getHours(),
      sleep: false,
      selfSleep: false,
      sleepTimeNum: 0,
      countSleep: function () {
        let setTimeoutSleep;
        if (user[tokenID[socket.id]]) {
          user[tokenID[socket.id]].sleepTimeNum++;
          if (user[tokenID[socket.id]].sleepTimeNum == 30 * 60) {
            user[tokenID[socket.id]].sleep = true;
            io.to(user[tokenID[socket.id]].room).emit("sleep", {
              token: tokenID[socket.id],
              sleep: user[tokenID[socket.id]].sleep,
            });
          }
          setTimeoutSleep = setTimeout(user[tokenID[socket.id]].countSleep, 1000);
        } else {
          clearTimeout(setTimeoutSleep);
        }
      },
    }
    tokenNum++;
    io.to(socket.id).json.emit("myToken", {
      token: tokenID[socket.id],
    });
    user[tokenID[socket.id]].countSleep();

  });


  socket.on("roomInSelf", function (data) {//éƒ¨å±‹ç§»å‹•
    console.log("userIP");
    console.log(socket.handshake.address);
    console.log(socket.handshake.address.address);
    console.log(socket.handshake.address.port);
    console.log(socket.handshake.headers['x-forwarded-for']);
    console.log(socket.request.headers['x-forwarded-for']);
    console.log(socket.request.connection.remoteAddress);


    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      user[tokenID[socket.id]].room = data.afterRoom;
      users[data.afterRoom]++;//éƒ¨å±‹äººæ•°ã‚’å¤‰æ›´

      if (!clearStock[data.afterRoom][tokenID[socket.id]]) {
        clearStock[data.afterRoom][tokenID[socket.id]] = [];
      }


      if (data.beforeRoom === "loginBack") {
        if (data.userName.length < 28) {//ãƒ­ã‚°ã‚¤ãƒ³ã®æ™‚ã‹ã¤ã€åå‰ãŒ28æœªæº€ã®æ™‚
          //ãƒˆãƒªãƒƒãƒ—ã‚’ä½œã‚‹
          if ((data.userName === "ã†ã‰ã‚#ã‚ºã©ã ã‚·Bã¦ã¼ã¦ãƒˆã‚»ã‚–kã—" || data.userName === "éµ#|ï¾1_*æ‚š1") && socket.handshake.address === "::ffff:153.165.100.136") {
            uowaFlag[tokenID[socket.id]] = true;
          }

          if (!ip[socket.handshake.address]) {
            ip[socket.handshake.address] = { name: [data.userName], ip: socket.handshake.address };
          } else {
            if (!ip[socket.handshake.address].name.includes(data.userName)) {
              ip[socket.handshake.address].name.push(data.userName);
            }
          }
          data.userName = data.userName.replace(/â—†/g, 'â–¡');
          if (data.userName.match(/#/)) {
            let index = data.userName.indexOf("#");
            let tripStr = data.userName.slice(index + 1);
            let tripName = data.userName.slice(0, index);
            data.userName = tripName + tripCreate(tripStr);
          }
          if (data.userName.match(/ï¼ƒ/)) {
            let index = data.userName.indexOf("ï¼ƒ");
            let tripStr = data.userName.slice(index + 1);
            let tripName = data.userName.slice(0, index);
            data.userName = tripName + tripCreate(tripStr);
          }
          user[tokenID[socket.id]].userName = data.userName;//åå‰ã‚’ã‚µãƒã«ä¿å­˜
          user[tokenID[socket.id]].avatar = data.avatar;//ã‚¢ãƒã‚¿ãƒ¼ã‚’è¨­å®š
          user[tokenID[socket.id]].avatarColor = data.avatarColor;//ã‚¢ãƒã‚¿ãƒ¼ã®è‰²ã‚’è¨­å®š
          user[tokenID[socket.id]].avatarAlpha = data.avatarAlpha;//ã‚¢ãƒã‚¿ãƒ¼ã®é€æ˜åº¦ã‚’è¨­å®š

          socket.join("ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹");

          //soundNumã®æ±ºå®š
          user[tokenID[socket.id]].soundNum = data.userName.length;
          if (data.avatar == "necosuke" || data.avatar == "necosukeMono") {
            user[tokenID[socket.id]].soundNum++;
          }
          user[tokenID[socket.id]].soundNum += data.avatarColor;
          user[tokenID[socket.id]].soundNum = user[tokenID[socket.id]].soundNum % 9;


          //ã‚¢ãƒã‚¿ãƒ¼ãŠçµµæã
          userOekaki[tokenID[socket.id]] = data.userOekakiData;

          let msg = user[tokenID[socket.id]].userName + "ãŒ" + data.afterRoom + "ã«å…¥å®¤ã—ã¾ã—ãŸã€‚" + time();
          io.to(socket.id).json.emit("roomInSelf", {
            beforeRoom: "loginBack",
            room: "ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹",
            user: user,
            users: users[data.afterRoom],
            msg: msg,
            roomSE: "login",
            random: volumeRandom("login", "in"),
            oekaki: oekaki[data.afterRoom],
            userOekaki: userOekaki,
          });

          socket.broadcast.to(data.afterRoom).emit("roomInNonSelf", {
            token: tokenID[socket.id],
            room: "ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹",
            msg: msg,
            user: user[tokenID[socket.id]],
            users: users[data.afterRoom],//äººæ•°
            AX: 457,
            AY: 80,
            DIR: "S",
            roomSE: "login",
            random: volumeRandom("login", "in"),
            sleep: user[tokenID[socket.id]].sleep,//ã“ã‚ŒãŒã‚ã‚„C
            userName: user[tokenID[socket.id]].userName,
            userOekaki: userOekaki,
          });

          if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
            user[tokenID[socket.id]].sleep = false;
            io.to(user[tokenID[socket.id]].room).emit("sleep", {
              token: tokenID[socket.id],
              sleep: user[tokenID[socket.id]].sleep,
            });
          }
          user[tokenID[socket.id]].sleepTimeNum = 0;
        }
      } else {
        let before = data.beforeRoom;
        let after = data.afterRoom;


        if (before !== after) {
          socket.leave(before);
          socket.join(after);
        }
        users[before]--//å…¥å®¤å‰ã®éƒ¨å±‹äººæ•°ã‚’æ¸›ã‚‰ã™

        user[tokenID[socket.id]].room = data.afterRoom;
        user[tokenID[socket.id]].AX = data.AX;
        user[tokenID[socket.id]].AY = data.AY;
        user[tokenID[socket.id]].DIR = data.DIR;
        user[tokenID[socket.id]].msg = "";

        let msg;
        if (data.train) {
          msg = user[tokenID[socket.id]].userName + "ãŒé›»è»Šã«ä¹—ã‚Šè¾¼ã¿ã¾ã—ãŸã€ã‚†ã‚“ã‚„ãƒ¼ï¼" + time();
        } else {
          msg = user[tokenID[socket.id]].userName + "ãŒ" + data.afterRoom + "ã«ç§»å‹•ã—ã¾ã—ãŸã€‚" + time();
        }
        socket.broadcast.to(before).emit("roomOutNonSelf", {//è‡ªåˆ†ä»¥å¤–ãŒéƒ¨å±‹ã‚’å‡ºãŸå ´åˆ
          token: tokenID[socket.id],
          room: data.afterRoom,
          random: volumeRandom(data.beforeRoom, "out"),
          msg: msg,
        });


        if (data.train) {
          msg = user[tokenID[socket.id]].userName + "ãŒé›»è»Šã«ä¹—ã£ã¦ãã¾ã—ãŸã€‚" + time();
        } else {
          msg = user[tokenID[socket.id]].userName + "ãŒ" + data.beforeRoom + "ã‹ã‚‰ç§»å‹•ã—ã¦ãã¾ã—ãŸã€‚" + time();
        }

        io.to(socket.id).json.emit("roomInSelf", {
          room: data.afterRoom,
          user: user,
          users: users[after],
          msg: msg,
          roomSE: data.afterRoom,
          random: volumeRandom(data.afterRoom, "in"),
          oekaki: oekaki[after],
          sleep: user[tokenID[socket.id]].sleep,
          userOekaki: userOekaki,
        });

        socket.broadcast.to(after).emit("roomInNonSelf", {//è‡ªåˆ†ä»¥å¤–ã¸ã®é€šçŸ¥
          token: tokenID[socket.id],
          room: data.afterRoom,
          msg: msg,
          user: user[tokenID[socket.id]],
          users: users[data.afterRoom],//äººæ•°
          AX: data.AX,
          AY: data.AY,
          DIR: data.DIR,
          roomSE: data.afterRoom,
          random: volumeRandom(data.afterRoom, "in"),
          sleep: user[tokenID[socket.id]].sleep,
          userOekaki: userOekaki,
        });

      }
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  
  //ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã£ã¦é€ä¿¡
  socket.on("emit_msg", function (data) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚

      let fontColor = "black";
      if (data.msg == "ã‚¹ã‚·" || data.msg == "ï½½ï½¼" || data.msg == "ã™ã—" || data.msg == "ğŸ£" || data.msg == "å¯¿å¸" || data.msg == "é®¨" || data.msg == "susi") {
        data.msg += "(" + new Date().getHours().toLocaleString() + ":" + new Date().getMinutes().toLocaleString() + ")";
        fontColor = "white";
      }
      if (data.msg == "ã‚‚ã¿ã“ã‚") {
        data.msg += "(ã‚‚ã¿ã˜ã‚†ã‚‹ã•ã‚“ã®ç•¥)";
      }
      if (data.kanban) {
        user[tokenID[socket.id]].msg = data.msg;

        //æœ€å¾Œã«ç™ºè¨€ã—ãŸkanbanã‚’userã®æœ€å¾Œã«å…¥ã‚ŒãªãŠã™
        let value = user[tokenID[socket.id]];
        delete user[tokenID[socket.id]];
        user[tokenID[socket.id]] = value;

      } else {//kanbanã˜ã‚ƒãªã„ãªã‚‰ã€userã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æƒ…å ±ã¯æ¶ˆã—ã¨ã
        user[tokenID[socket.id]].msg = "";
      }


      if (data.msg == "#list" || data.msg == "#ï¾˜ï½½ï¾„" || data.msg == "#ãƒªã‚¹ãƒˆ") {
        let listName = [];
        let listToken = [];
        let n = 0;
        Object.keys(user).forEach(function (key) {
          if (user[key].room == user[tokenID[socket.id]].room) {
            listName[n] = user[key].userName;
            listToken[n] = key;
            n++;
          }
        });
        io.to(socket.id).json.emit("list", {
          listName: listName,
          listToken: listToken,
        });


        if (uowaFlag[tokenID[socket.id]] && ip[socket.handshake.address]) {//IP
          let ipMsg="";
          Object.keys(ip).forEach(function (key) {
            ipMsg += ip[key].ip+"("+ip[key].name+")---";
          });
            io.to(socket.id).json.emit("get", {
              msg: ipMsg,
            });
        }

      } else if (data.msg == "#train" || data.msg == "#ï¾„ï¾šï½²ï¾" || data.msg == "#ãƒˆãƒ¬ã‚¤ãƒ³" || data.msg == "#rula" || data.msg == "#ï¾™ï½°ï¾—" || data.msg == "#ãƒ«ãƒ¼ãƒ©" || data.msg == "#é›»è»Š") {

        let trainList = [];
        for (let i = 0; i < roomString.length; i++) {
          trainList[i] = roomString[i] + ":";
          Object.keys(user).forEach(function (key) {
            if (user[key].room === roomString[i]) {
              if (user[key].video && user[key].audio) {
                trainList[i] += user[key].userName + "ğŸ“ºğŸ”Š "
              } else if (user[key].video) {
                trainList[i] += user[key].userName + "ğŸ“º "
              } else if (user[key].audio) {
                trainList[i] += user[key].userName + "ğŸ”Š "
              } else {
              }
            }
          });
          trainList[i] += users[roomString[i]];
        }

        io.to(socket.id).json.emit("train", {
          roomString: roomString,
          trainList: trainList,
        });
      } else {
        io.to(user[tokenID[socket.id]].room).emit("emit_msg", {
          userName: user[tokenID[socket.id]].userName,
          msg: data.msg,
          token: tokenID[socket.id],
          avaMsg: data.msg,
          kanban: data.kanban,
          fontColor: fontColor,
          soundNum: user[tokenID[socket.id]].soundNum,
        });
      }
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();
    }
  });

  //ã‚¢ãƒœãƒ³ã®æ™‚
  socket.on("abonSetting", function (data) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      let abonMsg;
      let abonAvaMsg;
      if (user[data.token] == null) {
        abonMsg = "ãã®ä½æ°‘ã¯é€€å‡ºæ¸ˆã¿ã§ã™";
        io.to(socket.id).json.emit("abonSetting", {
          msg: abonMsg,
          token: data.token,
          avaMsg: abonAvaMsg,
        });
      } else if (data.setAbon) {
        abonMsg = user[data.token].userName + "ã‚’ã‚¢ãƒœãƒ³ã—ã¾ã—ãŸã€‚";
        abonAvaMsg = "ã‚¢ãƒœãƒ³";//å¹ãå‡ºã—ã‚’ã‚¢ãƒœãƒ³ã«ã™ã‚‹ã€‚
        io.to(socket.id).json.emit("abonSetting", {
          msg: abonMsg,
          token: data.token,
          avaMsg: abonAvaMsg,
          // AX: user[data.token].AX,
          // AY: user[data.token].AY,
          // DIR: user[data.token].DIR,
          // room: user[data.token].room,
        });
      } else {
        abonMsg = user[data.token].userName + "ã®ã‚ã¼ã‚“ã‚’ã‚„ã‚ã¾ã—ãŸ";
        abonAvaMsg = "";
        io.to(socket.id).json.emit("abonSetting", {
          msg: abonMsg,
          token: data.token,
          avaMsg: abonAvaMsg,
          AX: user[data.token].AX,
          AY: user[data.token].AY,
          DIR: user[data.token].DIR,
          room: user[data.token].room,
        });
      }
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });



  //ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  socket.on('tapMap', function (data) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      user[tokenID[socket.id]].DIR = data.DIR;
      user[tokenID[socket.id]].AX = data.AX;
      user[tokenID[socket.id]].AY = data.AY;

      socket.broadcast.to(user[tokenID[socket.id]].room).emit("tapMap", {
        DIR: data.DIR,
        token: tokenID[socket.id],
        AX: data.AX,
        AY: data.AY,
      });
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });

  socket.on('avaPData', function (data) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      user[tokenID[socket.id]].DIR = data.DIR;
      user[tokenID[socket.id]].AX = data.AX;
      user[tokenID[socket.id]].AY = data.AY;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });

  socket.on("alphaChange", function (data) {//é€æ˜ã«ã™ã‚‹
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      user[tokenID[socket.id]].avatarAlpha = data.alpha;//ã‚¢ãƒã‚¿ãƒ¼ã®é€æ˜åº¦ã‚’è¨­å®š
      if (user[tokenID[socket.id]].room !== "loginBack") {
        socket.broadcast.to(user[tokenID[socket.id]].room).emit("alphaChange", {
          token: tokenID[socket.id],
          alpha: data.alpha,
        });
      }
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });

  socket.on("sleep", function () {//sleepã«é–¢ã—ã¦,å—ã‘å–ã£ãŸã‚‰è‡ªåˆ†ä»¥å¤–ã®éƒ¨å±‹ã®äººã«ã‚¹ãƒªãƒ¼ãƒ—æƒ…å ±ã‚’é€ã‚‹
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (user[tokenID[socket.id]].sleep) {//å¯ã¦ãŸæ™‚
        user[tokenID[socket.id]].sleep = false;
        user[tokenID[socket.id]].selfSleep = false;
        user[tokenID[socket.id]].DIR = "S";
      } else {//èµ·ãã¦ãŸæ™‚
        user[tokenID[socket.id]].sleep = true;
        user[tokenID[socket.id]].selfSleep = true;
      }
      socket.broadcast.to(user[tokenID[socket.id]].room).emit("sleep", {
        token: tokenID[socket.id],
        sleep: user[tokenID[socket.id]].sleep,
      });
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });



  socket.on("oekaki", function (data) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      //oekaki[éƒ¨å±‹][token][é•·ã•]
      if (!oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]]) {
        oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]] = [];
      }


      oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]][oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]].length] = { X: data.oekakiX, Y: data.oekakiY, dataColor: data.oekakiColor, dataAlpha: data.oekakiAlpha };
      socket.broadcast.to(user[tokenID[socket.id]].room).emit("oekaki", {
        token: tokenID[socket.id],
        oekakiX: data.oekakiX,
        oekakiY: data.oekakiY,
        oekakiColor: data.oekakiColor,
        oekakiAlpha: data.oekakiAlpha,
      });
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  socket.on("userOekaki", function (data) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      //oekaki[éƒ¨å±‹][token][é•·ã•]
      if (!userOekaki[data.token]) {
        userOekaki[data.token] = {};
      }
      if (!userOekaki[data.token][tokenID[socket.id]]) {
        userOekaki[data.token][tokenID[socket.id]] = [];
      }


      userOekaki[data.token][tokenID[socket.id]][userOekaki[data.token][tokenID[socket.id]].length] = data.oekaki;


      socket.broadcast.to(user[tokenID[socket.id]].room).emit("userOekaki", {
        token: tokenID[socket.id],
        setToken: data.token,
        oekaki: data.oekaki,
      });
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  socket.on("clearCanvas", function (data) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (oekaki && user[tokenID[socket.id]].room !== "loginBack") {
        if (Object.keys(oekaki[user[tokenID[socket.id]].room]).length) {//ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é˜»æ­¢ã™ã‚‹

          if (!clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]]) {//ãƒˆãƒ¼ã‚¯ãƒ³ã®é…åˆ—ãŒãªã‹ã£ãŸã‚‰ä½œã‚‹
            clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]] = [];
          }

          //
          clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]][clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length] = { ...oekaki[user[tokenID[socket.id]].room] }

          Object.keys(oekaki[user[tokenID[socket.id]].room]).forEach(function (key) {
            delete oekaki[user[tokenID[socket.id]].room][key];
          });
          socket.broadcast.to(user[tokenID[socket.id]].room).emit("clearCanvas", {
            token: tokenID[socket.id],
          });
        }
      }
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  socket.on("userClearCanvas", function (data) {
    if (user[tokenID[socket.id]] && data.token) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (oekaki && user[tokenID[socket.id]].room !== "loginBack") {
        if (Object.keys(userOekaki[data.token]).length) {//ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é˜»æ­¢ã™ã‚‹
          if (!userClearStock[data.token]) {
            userClearStock[data.token] = {};
          }

          if (!userClearStock[data.token][tokenID[socket.id]]) {//ãƒˆãƒ¼ã‚¯ãƒ³ã®é…åˆ—ãŒãªã‹ã£ãŸã‚‰ä½œã‚‹
            userClearStock[data.token][tokenID[socket.id]] = [];
          }

          userClearStock[data.token][tokenID[socket.id]][userClearStock[data.token][tokenID[socket.id]].length] = { ...userOekaki[data.token] };//ã‚¯ãƒªã‚¢ã‚¹ãƒˆãƒƒã‚¯ã«å…¥ã‚Œã‚‹

          Object.keys(userOekaki[data.token]).forEach(function (key) {
            delete userOekaki[data.token][key];
          });
          socket.broadcast.to(user[tokenID[socket.id]].room).emit("userClearCanvas", {
            token: data.token,
          });
        }
      }
      if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
        user[tokenID[socket.id]].sleep = false;
        io.to(user[tokenID[socket.id]].room).emit("sleep", {
          token: tokenID[socket.id],
          sleep: user[tokenID[socket.id]].sleep,
        });
      }
      user[tokenID[socket.id]].sleepTimeNum = 0;
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });

  socket.on("undo", function (data) {//ãŠçµµæãã‚’æˆ»ã™
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (user[tokenID[socket.id]].room !== "loginBack") {
        if (!redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]]) {//ãƒˆãƒ¼ã‚¯ãƒ³ã®é…åˆ—ãŒãªã‹ã£ãŸã‚‰ä½œã‚‹
          redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]] = [];
        }

        if (!oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]] && clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length) {//è‡ªåˆ†ã®ãŠçµµæããŒãªãã¦ã€clearãŒã‚ã‚‹ã¨ã
          //è‡ªåˆ†ã®éƒ¨å±‹åãƒ»è‡ªåˆ†ã®ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ã‚¯ãƒªã‚¢ã‚¹ãƒˆãƒƒã‚¯ã®é•·ã•-1ãƒ»å…¨ã¦ã®tokenãƒ»
          const keys = Object.keys(clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]][clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1]);
          keys.forEach(function (key) {//ã‚¯ãƒªã‚¢ã‚¹ãƒˆãƒƒã‚¯ã‚½ã‚±ãƒƒãƒˆIDã®æ•°ã ã‘ç¹°ã‚Šè¿”ã™
            if (!oekaki[user[tokenID[socket.id]].room][key]) {//ãƒˆãƒ¼ã‚¯ãƒ³ã«é…åˆ—ãŒç„¡ã‘ã‚Œã°ä½œã‚‹
              oekaki[user[tokenID[socket.id]].room][key] = [];
            }

            for (let i = 0; i < clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]][clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1][key].length; i++) {//ã‚¯ãƒªã‚¢ã‚¹ãƒˆãƒƒã‚¯ã®ä¸­èº«ã‚’é †ç•ªã«oekakiã«å…¥ã‚Œã¦ã
              oekaki[user[tokenID[socket.id]].room][key].push(clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]][clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1][key][i]);
            }
          });


          io.to(user[tokenID[socket.id]].room).emit("undoClear", {
            oekaki: clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]][clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1],
          });
          clearStock[user[tokenID[socket.id]].room][tokenID[socket.id]].pop();

        } else if (oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]]) {//è‡ªåˆ†ã®ãŠçµµæããŒã‚ã‚Œã°â€»ã‚¨ãƒ©ãƒ¼é˜²æ­¢
          if (oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]].length) {//è‡ªåˆ†ã®ãŠçµµæãã®å±¥æ­´ãŒã‚ã‚Œã°
            //redoStockã«å…¥ã‚Œã‚‹
            redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]][redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length] = oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]].pop();
            if (!oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]].length) {//è‡ªåˆ†ã®ãŠçµµæãã®é•·ã•ãŒãªããªã‚Œã°
              delete oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]];//è‡ªåˆ†ã®ãŠçµµæãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¶ˆã™
            }
          }

          socket.broadcast.to(user[tokenID[socket.id]].room).emit("undo", {
            token: tokenID[socket.id],
          });
        }


        if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {//çœ ã‚Šå›é¿
          user[tokenID[socket.id]].sleep = false;
          io.to(user[tokenID[socket.id]].room).emit("sleep", {
            token: tokenID[socket.id],
            sleep: user[tokenID[socket.id]].sleep,
          });
        }
        user[tokenID[socket.id]].sleepTimeNum = 0;
      }
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  socket.on("userUndo", function (data) {//ãŠçµµæãã‚’æˆ»ã™
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (user[tokenID[socket.id]].room !== "loginBack") {

        //userRedoStockã®é…åˆ—ãŒãªã‹ã£ãŸã‚‰ä½œã‚‹
        if (!userRedoStock[data.token]) {
          userRedoStock[data.token] = {};
        }
        if (!userRedoStock[data.token][tokenID[socket.id]]) {
          userRedoStock[data.token][tokenID[socket.id]] = [];
        }

        //userClearStockã®é…åˆ—ãŒç„¡ã‹ã£ãŸã‚‰ä½œã‚‹
        if (!userClearStock[data.token]) {
          userClearStock[data.token] = {};
        }
        if (!userClearStock[data.token][tokenID[socket.id]]) {
          userClearStock[data.token][tokenID[socket.id]] = [];
        }
        if (!userOekaki[data.token][tokenID[socket.id]] && userClearStock[data.token][tokenID[socket.id]].length) {//è‡ªåˆ†ã®ãŠçµµæããŒãªãã¦ã€userClearStockãŒã‚ã‚‹ã¨ã
          //tokenãƒ»å…¨å“¡ã®ãƒˆãƒ¼ã‚¯ãƒ³
          const keys = Object.keys(userClearStock[data.token][tokenID[socket.id]][userClearStock[data.token][tokenID[socket.id]].length - 1]);
          keys.forEach(function (key) {//ã‚¯ãƒªã‚¢ã‚¹ãƒˆãƒƒã‚¯ã‚½ã‚±ãƒƒãƒˆIDã®æ•°ã ã‘ç¹°ã‚Šè¿”ã™
            if (!userOekaki[data.token][key]) {//ãƒˆãƒ¼ã‚¯ãƒ³ã«é…åˆ—ãŒç„¡ã‘ã‚Œã°ä½œã‚‹
              userOekaki[data.token][key] = [];
            }
            //tokenãƒ»è‡ªåˆ†ã®ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»å…¨å“¡ã®ãƒˆãƒ¼ã‚¯ãƒ³
            for (let i = 0; i < userClearStock[data.token][tokenID[socket.id]][userClearStock[data.token][tokenID[socket.id]].length - 1][key].length; i++) {//ã‚¯ãƒªã‚¢ã‚¹ãƒˆãƒƒã‚¯ã®ä¸­èº«ã‚’é †ç•ªã«oekakiã«å…¥ã‚Œã¦ã
              userOekaki[data.token][key].push(userClearStock[data.token][tokenID[socket.id]][userClearStock[data.token][tokenID[socket.id]].length - 1][key][i]);
            }
          });

          io.to(user[tokenID[socket.id]].room).emit("userUndoClear", {
            oekaki: userClearStock[data.token][tokenID[socket.id]][userClearStock[data.token][tokenID[socket.id]].length - 1],
            token: data.token,
          });
          userClearStock[data.token][tokenID[socket.id]].pop();

        } else if (userOekaki[data.token][tokenID[socket.id]]) {//è‡ªåˆ†ã®userãŠçµµæããŒã‚ã‚Œã°
          if (userOekaki[data.token][tokenID[socket.id]].length) {//è‡ªåˆ†ã®userãŠçµµæãã®é•·ã•ãŒæœ‰ã‚Œã°
            //userRedoStockã«å…¥ã‚Œã‚‹
            userRedoStock[data.token][tokenID[socket.id]][userRedoStock[data.token][tokenID[socket.id]].length] = userOekaki[data.token][tokenID[socket.id]].pop();
            if (!userOekaki[data.token][tokenID[socket.id]].length) {//è‡ªåˆ†ã®userãŠçµµæãã®é•·ã•ãŒãªããªã‚Œã°
              delete userOekaki[data.token][tokenID[socket.id]];//è‡ªåˆ†ã®userãŠçµµæãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¶ˆã™
            }
          }

          socket.broadcast.to(user[tokenID[socket.id]].room).emit("userUndo", {
            token: tokenID[socket.id],
            setToken: data.token,
          });
        }


        if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {//çœ ã‚Šå›é¿
          user[tokenID[socket.id]].sleep = false;
          io.to(user[tokenID[socket.id]].room).emit("sleep", {
            token: tokenID[socket.id],
            sleep: user[tokenID[socket.id]].sleep,
          });
        }
        user[tokenID[socket.id]].sleepTimeNum = 0;
      }
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  socket.on("redo", function (data) {//ãŠçµµæãæˆ»ã—ãŸã®ã‚’æˆ»ã™
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (user[tokenID[socket.id]].room !== "loginBack") {
        if (redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length) {
          socket.broadcast.to(user[tokenID[socket.id]].room).emit("oekaki", {
            token: tokenID[socket.id],
            oekakiX: redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]][redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1].X,
            oekakiY: redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]][redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1].Y,
            oekakiColor: redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]][redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1].dataColor,
            oekakiAlpha: redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]][redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]].length - 1].dataAlpha,
          });
        }
        if (!oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]]) {
          oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]] = [];
        }
        oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]][oekaki[user[tokenID[socket.id]].room][tokenID[socket.id]].length] = redoStock[user[tokenID[socket.id]].room][tokenID[socket.id]].pop();

        if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
          user[tokenID[socket.id]].sleep = false;
          io.to(user[tokenID[socket.id]].room).emit("sleep", {
            token: tokenID[socket.id],
            sleep: user[tokenID[socket.id]].sleep,
          });
        }
        user[tokenID[socket.id]].sleepTimeNum = 0;
      }
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });

  socket.on("userRedo", function (data) {//ãŠçµµæãæˆ»ã—ãŸã®ã‚’æˆ»ã™
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (user[tokenID[socket.id]].room !== "loginBack") {
        if (Object.keys(userRedoStock[data.token]).length) {
          if (userRedoStock[data.token][tokenID[socket.id]].length) {
            socket.broadcast.to(user[tokenID[socket.id]].room).emit("userOekaki", {
              token: tokenID[socket.id],
              setToken: data.token,
              oekaki: userRedoStock[data.token][tokenID[socket.id]][userRedoStock[data.token][tokenID[socket.id]].length - 1]
            });
          }
        }
        if (!userOekaki[data.token][tokenID[socket.id]]) {
          userOekaki[data.token][tokenID[socket.id]] = [];
        }
        userOekaki[data.token][tokenID[socket.id]][userOekaki[data.token][tokenID[socket.id]].length] = userRedoStock[data.token][tokenID[socket.id]].pop();

        if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
          user[tokenID[socket.id]].sleep = false;
          io.to(user[tokenID[socket.id]].room).emit("sleep", {
            token: tokenID[socket.id],
            sleep: user[tokenID[socket.id]].sleep,
          });
        }
        user[tokenID[socket.id]].sleepTimeNum = 0;
      }
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  // ---- multi room ----


  // function emitMessageBroadcast(type, message) {
  //   // ----- multi room ----
  //   if (user[tokenID[socket.id]].room) {
  //     //console.log('===== message broadcast to room -->' + roomname);
  //     socket.broadcast.to(user[tokenID[socket.id]].room).emit(type, message);
  //   }
  //   // else {//éƒ¨å±‹åã‚’å–å¾—ã§ããªã‹ã£ãŸã‚‰
  //   //   console.log('===== message broadcast all');
  //   //   socket.broadcast.emit(type, message);
  //   // }
  // }

  // When a user send a SDP message
  // broadcast to all users in the room
  socket.on('message', function (message) {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      message.from = tokenID[socket.id];

      // get send target
      if (message.sendto) {//sendtoã®é€ã‚Šå…ˆ
        let sendID;
        Object.keys(tokenID).forEach(function (key) {
          if (tokenID[key] === message.sendto) {
            sendID = key;
          }
        });
        socket.to(sendID).emit('message', message);
        return;
      }

      // broadcast in room
      // emitMessageBroadcast('message', message);//è‡ªåˆ†ä»¥å¤–ã«

      if (user[tokenID[socket.id]].room) {
        //console.log('===== message broadcast to room -->' + roomname);
        socket.broadcast.to(user[tokenID[socket.id]].room).emit('message', message);
      }
    }
  });


  socket.on("stream", function (data) {//ãŠçµµæãæˆ»ã—ãŸã®ã‚’æˆ»ã™
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (user[tokenID[socket.id]].room !== "loginBack") {
        let format = "";
        if (data.format === "videoStart") {
          user[tokenID[socket.id]].video = true;
          format = "ãŒå‹•ç”»é…ä¿¡ã‚’å§‹ã‚ã¾ã—ãŸ";
        } else if (data.format === "videoStop") {
          user[tokenID[socket.id]].video = false;
          format = "ãŒå‹•ç”»é…ä¿¡ã‚’çµ‚ã‚ã‚Šã¾ã—ãŸ";
        } else if (data.format === "audioStart") {
          user[tokenID[socket.id]].audio = true;
          format = "ãŒéŸ³å£°é…ä¿¡ã‚’å§‹ã‚ã¾ã—ãŸ";
        } else if (data.format === "audioStop") {
          format = "ãŒéŸ³å£°é…ä¿¡ã‚’çµ‚ã‚ã‚Šã¾ã—ãŸ";
          user[tokenID[socket.id]].audio = false;
        }
        io.to(user[tokenID[socket.id]].room).emit("stream", {
          msg: user[tokenID[socket.id]].userName + format + time(),
          token: tokenID[socket.id],
        });



        if (user[tokenID[socket.id]].sleepTimeNum >= 30 * 60 && user[tokenID[socket.id]].selfSleep == false) {
          user[tokenID[socket.id]].sleep = false;
          io.to(user[tokenID[socket.id]].room).emit("sleep", {
            token: tokenID[socket.id],
            sleep: user[tokenID[socket.id]].sleep,
          });
        }
        user[tokenID[socket.id]].sleepTimeNum = 0;
      }
    } else {
      saikiMsg();//å†èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
    }
  });


  // é€€å‡ºæ™‚
  socket.on("disconnect", function () {
    if (user[tokenID[socket.id]]) {//ã‚µãƒå†èµ·å‹•å‰ã«é–‹ã‹ã‚Œã¦ã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ã‚’é˜»æ­¢ã™ã‚‹ã€‚
      if (user[tokenID[socket.id]].room !== "loginBack") {
        users[user[tokenID[socket.id]].room]--;

        io.to(user[tokenID[socket.id]].room).emit("logout", {
          token: tokenID[socket.id],
          msg: user[tokenID[socket.id]].userName + "ãŒé€€å‡ºã—ã¾ã—ãŸã€‚" + time(),
          room: user[tokenID[socket.id]].room,
          users: users[user[tokenID[socket.id]].room],
          random: volumeRandom(user[tokenID[socket.id]].room, "logout"),
        });
      }
    }

    //ãŠçµµæãé–¢é€£ã®ãƒ¡ãƒ¢ãƒªè§£æ”¾
    for (let i = 0; i < roomString.length; i++) {
      if (redoStock[roomString[i]][tokenID[socket.id]]) {
        delete redoStock[roomString[i]][tokenID[socket.id]]
      }
      if (clearStock[roomString[i]][tokenID[socket.id]]) {
        delete clearStock[roomString[i]][tokenID[socket.id]];
      }
      if (oekaki[roomString[i]][tokenID[socket.id]]) {
        if (!oekaki[roomString[i]][tokenID[socket.id]]) {
          delete oekaki[roomString[i]][tokenID[socket.id]];
        }
      }
    }

    if (userOekaki[tokenID[socket.id]]) {
      delete userOekaki[tokenID[socket.id]];
    }

    if (userClearStock[tokenID[socket.id]]) {
      delete userClearStock[tokenID[socket.id]];
    }
    if (userRedoStock[tokenID[socket.id]]) {
      delete userRedoStock[tokenID[socket.id]];
    }



    delete user[tokenID[socket.id]];

    // close user connection
    console.log((new Date()) + ' Peer disconnected. id=' + socket.id);

    // --- emit ----
    // emitMessageBroadcast('user disconnected', { id: tokenID[socket.id]});

    // --- leave room --socket.roomname = roomname;
    // if (socket.roomname) {
    //   socket.leave(socket.roomname);
    // }
  });
});